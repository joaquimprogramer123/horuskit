<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="face-api.js-master/dist/face-api.js"></script>
    <style>
        #videoStream {
            position: relative;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>

<h1>Vídeo WebRTC</h1>

<div id="videoStream">
    <video id="myVideo" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
</div>

<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-storage-compat.js"></script>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAdVrAXk70WCDvw6nveao9SwCAAAbIpsts",
        authDomain: "horus-87f81.firebaseapp.com",
        projectId: "horus-87f81",
        storageBucket: "horus-87f81.appspot.com",
        messagingSenderId: "692067844473",
        appId: "1:692067844473:web:1a18ba28a30c0f48332fa8",
        measurementId: "G-FR49ZZTE4E"
    };

    // Initialize Firebase
    async function initializeFirebase() {
        // Verifica se o Firebase já está inicializado
        if (!firebase.apps.length) {
            // Se não estiver inicializado, inicializa-o
            await firebase.initializeApp(firebaseConfig);
            console.log("Firebase inicializado com sucesso!");
        }
        // Se já estiver inicializado, não faz nada
    }

    // Função para iniciar a câmera e transmitir o vídeo para o elemento de vídeo
    async function startVideo() {
        const video = document.getElementById('myVideo');
        const canvas = document.getElementById('overlay');
        try {
            // Solicitar permissão do usuário para acessar a câmera
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });

            // Adicionar o fluxo de vídeo ao elemento de vídeo
            video.srcObject = stream;

            // Redimensionar o canvas para corresponder ao tamanho do vídeo
            video.addEventListener('play', () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            });

            // Inicializa o Firebase após garantir que o vídeo está carregado e pronto
            await initializeFirebase();

            // Inicia a detecção de rostos a cada 1000 milissegundos
            setInterval(() => detectAndCompareFaces(video, canvas), 1000);
        } catch (error) {
            console.error('Erro ao acessar a câmera: ', error);
            alert('Não foi possível acessar a câmera. Verifique se as permissões estão corretas.');
        }
    }

    // Função para detectar rostos e compará-los com as imagens no Firebase Storage
    async function detectAndCompareFaces(video, canvas) {
        // Configuração para o detector de rostos
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 128, scoreThreshold: 0.5 });
        try {
            // Detecta rosto no vídeo com descritor de rosto
            const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
            if (detection) {
                const { box } = detection.detection;
                // Verifica se a bounding box é válida
                if (box && box.top !== null && box.bottom !== null && box.left !== null && box.right !== null) {
                    console.log('Bounding box válida:', box);
                    // Desenhar a bounding box no canvas
                    const dims = faceapi.matchDimensions(canvas, video, true);
                    const resizedDetections = faceapi.resizeResults(detection, dims);
                    faceapi.draw.drawDetections(canvas, resizedDetections);

                    // Compara o rosto detectado com as imagens no Firebase Storage
                    await compareFaceWithStoredImages(detection.descriptor);
                } else {
                    console.error('Bounding box inválida:', box);
                }
            }
        } catch (error) {
            console.error('Erro ao detectar rosto:', error);
        }
    }

    // Função para comparar o rosto detectado com as imagens no Firebase Storage
    async function compareFaceWithStoredImages(detectedFaceDescriptor) {
        // Recupera a referência do Firebase Storage
        const storageRef = firebase.storage().ref();

        try {
            // Recupera a lista de imagens salvas no Firebase Storage
            const imageList = await storageRef.listAll();
            
            // Verifica se há imagens no storage
            if (imageList.items.length === 0) {
                console.log("Nenhuma imagem encontrada no Firebase Storage.");
                return;
            }
        } catch (error) {
            console.error('Erro ao comparar rosto com imagens no Firebase Storage:', error);
        }
    }

    // Iniciar o vídeo quando a página é carregada
    startVideo();
</script>
</body>
</html>
