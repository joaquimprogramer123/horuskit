<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="face-api.js-master/dist/face-api.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #videoStream {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video, canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>

<!-- Instancia para importar as bibliotecas do firebase namespace-->

<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-storage-compat.js"></script>

    

     <!-- Intancia para conectar com o firebase-->

    <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAdVrAXk70WCDvw6nveao9SwCAAAbIpsts",
    authDomain: "horus-87f81.firebaseapp.com",
    projectId: "horus-87f81",
    storageBucket: "horus-87f81.appspot.com",
    messagingSenderId: "692067844473",
    appId: "1:692067844473:web:1a18ba28a30c0f48332fa8",
    measurementId: "G-FR49ZZTE4E"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>


    
    <h1>Vídeo WebRTC</h1>

    <div id="videoStream">
        <video id="myVideo" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    
    <script type="module">

    // TODO: Replace the following with your app's Firebase project configuration
    // See: https://firebase.google.com/docs/web/learn-more#config-object
    const firebaseConfig = {
        apiKey: "AIzaSyAdVrAXk70WCDvw6nveao9SwCAAAbIpsts",
        authDomain: "horus-87f81.firebaseapp.com",
        projectId: "horus-87f81",
        storageBucket: "horus-87f81.appspot.com",
        messagingSenderId: "692067844473",
        appId: "1:692067844473:web:1a18ba28a30c0f48332fa8",
        measurementId: "G-FR49ZZTE4E"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

        // Carrega os modelos necessários e inicia o vídeo

        // Função para carregar modelos de forma mais robusta
async function loadModels() {
    await faceapi.nets.ssdMobilenetv1.loadFromUri('/models');
    await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
    await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
}

// Função para iniciar a câmera e transmitir o vídeo para o elemento de vídeo
async function startVideo() {
    const video = document.getElementById('myVideo');
    const canvas = document.getElementById('overlay');
    try {
        // Solicitar permissão do usuário para acessar a câmera
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        // Redimensionar o canvas para corresponder ao tamanho do vídeo
        video.addEventListener('play', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        });

        // Inicia a detecção de rostos a cada 1000 milissegundos
        setInterval(() => detectAndCompareFaces(video, canvas), 1000);
    } catch (error) {
        console.error('Erro ao acessar a câmera: ', error);
        alert('Não foi possível acessar a câmera. Verifique se as permissões estão corretas.');
    }
}

// Função para detectar rostos e compará-los com as imagens no Firebase Storage
async function detectAndCompareFaces(video, canvas) {
    const options = new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 });
    try {
        const detections = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
        if (detections) {
            const { box } = detections.detection;
            if (box) {
                console.log('Bounding box válida:', box);
                const dims = faceapi.matchDimensions(canvas, video, true);
                const resizedDetections = faceapi.resizeResults(detections, dims);
                faceapi.draw.drawDetections(canvas, resizedDetections);
                await compareFaceWithStoredImages(detections.descriptor);
            } else {
                console.error('Bounding box inválida:', box);
            }
        }
    } catch (error) {
        console.error('Erro ao detectar rosto:', error);
    }
}

// Função para comparar descritores de rosto com imagens armazenadas no Firebase Storage
async function compareFaceWithStoredImages(detectedFaceDescriptor) {
    const storageRef = firebase.storage().ref();
    let matchFound = false;

    try {
        const imageList = await storageRef.listAll();
        for (const imageRef of imageList.items) {
            const imageURL = await imageRef.getDownloadURL();
            const image = await faceapi.fetchImage(imageURL);
            const faceDetection = await faceapi.detectSingleFace(image).withFaceLandmarks().withFaceDescriptor();
            
            if (faceDetection) {
                const distance = faceapi.euclideanDistance(detectedFaceDescriptor, faceDetection.descriptor);
                const similarityThreshold = 0.6; // Ajuste conforme necessário
                
                if (distance < similarityThreshold) {
                    console.log(`Correspondência encontrada com ${imageRef.name}`);
                    matchFound = true;
                    break;
                }
            }
        }

        if (matchFound) {
            window.location.href = 'autorizado.html';
        } else {
            window.location.href = 'negado.html';
        }
    } catch (error) {
        console.error('Erro ao comparar rostos:', error);
        window.location.href = 'negado.html';
    }
}

// Carrega os modelos e inicia o vídeo
loadModels().then(startVideo);

        
// Verifica se o Face-API está carregado corretamente e pronto para uso
if (faceapi.nets.ssdMobilenetv1 && faceapi.nets.faceLandmark68Net && faceapi.nets.faceRecognitionNet) {
    console.log('Face-API carregado com sucesso!');
} else {
    console.error('Erro ao carregar o Face-API. Verifique se os modelos foram carregados corretamente.');
}

// Verifica se é possível acessar as fotos do Firebase Storage e compará-las com o rosto detectado
async function testFaceComparison() {
    const storageRef = firebase.storage().ref();
    try {
        const imageList = await storageRef.listAll();
        if (imageList.items.length > 0) {
            console.log('Fotos encontradas no Firebase Storage. Iniciando comparação de rostos...');
            // Insira aqui o código para comparar as fotos do Firebase Storage com o rosto detectado
        } else {
            console.warn('Nenhuma foto encontrada no Firebase Storage. Não é possível realizar a comparação de rostos.');
        }
    } catch (error) {
        console.error('Erro ao acessar o Firebase Storage:', error);
    }
}

// Chama a função para testar a comparação de rostos
testFaceComparison();

    
    </script>
</body>
</html>
